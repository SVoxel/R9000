<% http_header("style/form.css", "/funcs.js") %>
<% body_header("_vpn", "vpn_pptp.htm", "vpn_pptp") %>

<% save_timestamp("vpn_pptp","vpn_pptp_del", "vpn_pptp_edit_num", "vpn_pptp_add", "vpn_pptp_edit" ) %>

<div class="page_title">$vpn_head</div>
<div class="fix_button">
<TABLE width=100% border=0 cellpadding=0 cellspacing=2>
<script>
var master="<% cfg_get("http_loginname") %>";
var ts = "<% cfg_get("vpn_pptp") %>";
if( master == "admin" )
        document.write('<TR><TD nowrap colspan=2 align=center><input class="cancel_bt" type="button" name="Cancel" value="$cancel_mark" onClick="location.href=\'vpn_pptp.htm\';">&nbsp;&nbsp;<input class="apply_bt" type="submit" name="Apply" value="$apply_mark" onClick="return check_vpn(document.forms[0]);"></TD></TR>');
else
        document.write('<TR><TD nowrap colspan=2 align=center><input class="cancel1_bt" type="button" name="Cancel" value="$cancel_mark" disabled>&nbsp;&nbsp;<input class="apply1_bt" type="submit" name="Apply" value="$apply_mark" disabled></TD></TR>');
</script>
</TABLE>
</div>
<div id="main" class="main_top_button">
<input type="hidden" name="select_edit" value=0>
<input type="hidden" name="select_del" value=0>
<TABLE cellspacing=5 cellPadding=0 width=100% border=0>
<TR>
	<TD nowrap colspan=2>
	<input type="hidden" name="hidden_enable_vpn">
	<input type="checkbox" name="cb_enable" value="1"><font id="enable_vpn_text">$vpn_enable</font>
	</TD>
</TR>
$bluebar
<TR><TD colspan=2  nowrap><b>User Account</b></TD></TR>
<TR>
        <TD nowrap colspan=2><div align=center>
        <TABLE class=tables border=0 cellpadding=2 cellspacing=0 width=100%>
        <TR class=table_header>
                <TD nowrap align=center>&nbsp;</TD>
                <TD nowrap align=center><span class="subhead">Username</span></TD>
                <TD nowrap align=center><span class="subhead">Password</span></TD>
        </TR>
<script>
<% pptpd_all_users() %>

        for(var i=1; i<=pptp_user_num; i++)
        {
                var cp_name = eval("user_name"+i);
		var cp_pwd = eval("user_pwd"+i);

                if( i%2== 0 )
                        document.write("<TR class=\"even_line\">");
                else
                        document.write("<TR class=\"odd_line\">");

		document.write('<TD nowrap align=center><input type="radio" name="ruleSelect" value="'+i+'"></TD>');
		document.write('<TD nowrap align=center>'+cp_name+'</TD>');
		document.write('<TD nowrap align=center>'+cp_pwd+'</TD></tr>');
        }

</script>
	</table>
	</td>
</tr>
<TR>
        <TD nowrap colspan=2 align=center>
        <input class="add_bt"  type="button" name="Add" value="$add_mark" onClick="location.href='vpn_pptp_add.htm';">
        <input class="edit_bt" type="button" name="Edit" value="$edit_mark" onClick="click_edit();">
        <script>
        if( master == "admin" )
                document.write('<input class="delete_bt" type="button" name="Delete" value="$delete_mark" onClick="return click_del();">');
        else
                document.write('<input class="delete1_bt" type="submit" name="Delete" value="$delete_mark" disabled>');
        </script>
        </TD>
</TR>

<TR><TD colspan=2  nowrap><b>IP Address</b></TD></TR>
<tr>
	<td nowrap>Local IP Address</td>
	<td nowrap>
	<input type="hidden" name="tx_local_ip">
	<input type="text" name="tx_local_ip_1"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_local_ip_2"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_local_ip_3"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_local_ip_4"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >
	</td>
</tr>
<tr>
        <td nowrap>Remote IP Address</td>
	<td nowrap><input type="hidden" name="tx_remote_min">
	<input type="text" name="tx_remote_min_1"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_remote_min_2"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_remote_min_3"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_remote_min_4"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" > - 
	<input type="hidden" name="tx_remote_max">
	<input type="text" name="tx_remote_max_1"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_remote_max_2"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_remote_max_3"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
	<input type="text" name="tx_remote_max_4"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >
	</td>
</tr>

<TR><TD colspan=2  nowrap><b>Encryption</b></TD></TR>
<TR>
        <TD nowrap colspan=2>
	<input type="radio" name="rd_encryption" value="none">None&nbsp;&nbsp;
        <input type="radio" name="rd_encryption" value="mppe">MPPE
        </TD>
</TR>
<TR><TD colspan=2  nowrap><b>Authentication</b></TD></TR>
<TR>
        <TD nowrap colspan=2>
	<input type="hidden" name="auth_pap">
	<input type="checkbox" name="cb_auth_pap">PAP &nbsp;
	<input type="hidden" name="auth_chap">
	<input type="checkbox" name="cb_auth_chap">CHAP &nbsp;
	<input type="hidden" name="auth_ms">
	<input type="checkbox" name="cb_auth_ms">MS-CHAP v2 
        </TD>
</TR>
<TR><TD colspan=2  nowrap><b>Setting DNS server</b></TD></TR>
<TR>
        <TD nowrap colspan=2>
        <input type="radio" name="rd_dns_type" value="0" onclick="set_dns_server(0)">None
        </TD>
</TR>
<TR>
        <TD nowrap colspan=2>
        <input type="radio" name="rd_dns_type" value="1" onclick="set_dns_server(1)">Use server Ip of VPN tunnel
        </TD>
</TR>
<TR>
        <TD nowrap >
        <input type="radio" name="rd_dns_type" value="2" onclick="set_dns_server(2)">Static
        </TD>
	<td nowrap>
        <input type="hidden" name="tx_static_dns">
        <input type="text" name="tx_static_dns_1"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
        <input type="text" name="tx_static_dns_2"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
        <input type="text" name="tx_static_dns_3"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
        <input type="text" name="tx_static_dns_4"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >
        </td>
</TR>

<TR><TD colspan=2  nowrap><b>Setting WINS server</b></TD></TR>
<TR>
        <TD nowrap colspan=2>
        <input type="radio" name="rd_wins_type" value="0" onclick="set_wins_server(0)" >None
        </TD>
</TR>
<TR>
        <TD nowrap colspan=2>
        <input type="radio" name="rd_wins_type" value="1" onclick="set_wins_server(1)" >Use server Ip of VPN tunnel
        </TD>
</TR>
<TR>
        <TD nowrap >
        <input type="radio" name="rd_wins_type" value="2" onclick="set_wins_server(2)" >Static
        </TD>
        <td nowrap>
        <input type="hidden" name="tx_static_wins">
        <input type="text" name="tx_static_wins_1"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
        <input type="text" name="tx_static_wins_2"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
        <input type="text" name="tx_static_wins_3"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >.
        <input type="text" name="tx_static_wins_4"  size="3" autocomplete="off" maxlength="3" onFocus="this.select();" onkeydown="keydown(event,this);" onKeyPress="return getkey('num',event);" onkeyup="keyup(event,this);" >
        </td>
</TR>
<TR><TD colspan=2  nowrap><b>Broadcast Packets via PPTP Tunnel</b></TD></TR>
<TR>
        <TD nowrap colspan=2>
	<input type="hidden" name="allow_broad">
        <input type="checkbox" name="cb_allow_broad"> Allowed
        </TD>
</TR>
$bluebar
<TR><TD colspan=2  nowrap><b>Active Tunnel Status</b></TD></TR>
<TR>
        <TD nowrap colspan=2>
        <TABLE class=tables border=0 cellpadding=2 cellspacing=0 width=100%>
        <TR class=table_header>
                <TD nowrap align=center><span class="subhead">User</span></TD>
                <TD nowrap align=center><span class="subhead">From</span></TD>
                <TD nowrap align=center><span class="subhead">Local IP</span></TD>
		<TD nowrap align=center><span class="subhead">Remote IP</span></TD>

        </TR>
<% pptpd_status() %>

        </table>

        </TD>
</TR>


</TABLE>
</div>
<% help_box("0","_vpn_pptp") %>
</FORM>
</BODY>
<script>
var pre_enable="<% cfg_sed_xss("vpn_pptp_enabled") %>";
var pre_local_ip="<% cfg_sed_xss("vpn_pptp_locip") %>";
var pre_remote_min="<% cfg_sed_xss("vpn_pptp_rmtip_min") %>";
var pre_remote_max="<% cfg_sed_xss("vpn_pptp_rmtip_max") %>";
var pre_encryption="<% cfg_sed_xss("vpn_pptp_enc") %>";
var pre_auth_pap="<% cfg_sed_xss("vpn_pptp_auth_pap") %>";
var pre_auth_chap="<% cfg_sed_xss("vpn_pptp_auth_chap") %>";
var pre_auth_ms="<% cfg_sed_xss("vpn_pptp_auth_mschapv2") %>";
var pre_dns_type="<% cfg_sed_xss("vpn_pptp_dns") %>";
var pre_static_dns="<% cfg_sed_xss("vpn_pptp_static_dns") %>";
var pre_wins_type="<% cfg_sed_xss("vpn_pptp_wins") %>";
var pre_static_wins="<% cfg_sed_xss("vpn_pptp_static_wins") %>";
var pre_pptp_broadcast="<% cfg_sed_xss("vpn_pptp_broadcast") %>";

function set_dns_server(type)
{
	var cf = document.forms[0];
	if(type == 2)
	{
		cf.tx_static_dns_1.disabled = false;
		cf.tx_static_dns_2.disabled = false;
		cf.tx_static_dns_3.disabled = false;
		cf.tx_static_dns_4.disabled = false;
	}
	else
	{
		cf.tx_static_dns_1.disabled = true;
		cf.tx_static_dns_2.disabled = true;
		cf.tx_static_dns_3.disabled = true;
		cf.tx_static_dns_4.disabled = true;
	}
}

function set_wins_server(type)
{
        var cf = document.forms[0];
        if(type == 2)
        {
                cf.tx_static_wins_1.disabled = false;
                cf.tx_static_wins_2.disabled = false;
                cf.tx_static_wins_3.disabled = false;
                cf.tx_static_wins_4.disabled = false;
        }
        else
        {
                cf.tx_static_wins_1.disabled = true;
                cf.tx_static_wins_2.disabled = true;
                cf.tx_static_wins_3.disabled = true;
                cf.tx_static_wins_4.disabled = true;
        }
}

function loadvalue()
{
        var cf = document.forms[0];
	load_checkbox_value(pre_enable, cf.cb_enable);

	if( pre_local_ip != "" )
	{
		var ip_array=pre_local_ip.split('.');
		if(ip_array.length == 4)
		{
			cf.tx_local_ip_1.value=ip_array[0];
			cf.tx_local_ip_2.value=ip_array[1];
			cf.tx_local_ip_3.value=ip_array[2];
			cf.tx_local_ip_4.value=ip_array[3];
		}
	}

	if(pre_remote_min!="")
	{
		var ip_array=pre_remote_min.split('.');
		if(ip_array.length==4)
		{
			cf.tx_remote_min_1.value=ip_array[0];
			cf.tx_remote_min_2.value=ip_array[1];
			cf.tx_remote_min_3.value=ip_array[2];
			cf.tx_remote_min_4.value=ip_array[3];
		}
	}

	if( pre_remote_max!="" )
	{
		var gateway_array=pre_remote_max.split('.');
		if(gateway_array.length == 4)
		{
			cf.tx_remote_max_1.value=gateway_array[0];
			cf.tx_remote_max_2.value=gateway_array[1];
			cf.tx_remote_max_3.value=gateway_array[2];
			cf.tx_remote_max_4.value=gateway_array[3];
		}
	}

	if( pre_encryption == "none" )
		cf.rd_encryption[0].checked = true;
	else
		cf.rd_encryption[1].checked = true;

	load_checkbox_value(pre_auth_pap, cf.cb_auth_pap);
	load_checkbox_value(pre_auth_chap, cf.cb_auth_chap);
	load_checkbox_value(pre_auth_ms, cf.cb_auth_ms);

	cf.rd_dns_type[pre_dns_type].checked = true;
	set_dns_server(pre_dns_type);
	if( pre_static_dns != "" )
	{
		var dns_array=pre_static_dns.split('.');
		if( dns_array.length == 4 )
		{
			cf.tx_static_dns_1.value=dns_array[0];
			cf.tx_static_dns_2.value=dns_array[1];
			cf.tx_static_dns_3.value=dns_array[2];
			cf.tx_static_dns_4.value=dns_array[3];
		}
	}

	cf.rd_wins_type[pre_wins_type].checked = true;
	set_wins_server(pre_wins_type);
	if( pre_static_wins != "" )
	{
		var wins_array=pre_static_wins.split('.');
		if( wins_array.length ==  4)
		{
			cf.tx_static_wins_1.value=wins_array[0];
			cf.tx_static_wins_2.value=wins_array[1];
			cf.tx_static_wins_3.value=wins_array[2];
			cf.tx_static_wins_4.value=wins_array[3];
		}
	}

	load_checkbox_value(pre_pptp_broadcast, cf.cb_allow_broad);
}


function check_vpn(cf)
{
	set_checkbox_value(cf.cb_enable, cf.hidden_enable_vpn);

	cf.tx_local_ip.value = cf.tx_local_ip_1.value+'.'+cf.tx_local_ip_2.value+'.'+cf.tx_local_ip_3.value+'.'+cf.tx_local_ip_4.value;
	if(cf.tx_local_ip.value == "...")
		cf.tx_local_ip.value = "";
	cf.tx_remote_min.value = cf.tx_remote_min_1.value+'.'+cf.tx_remote_min_2.value+'.'+cf.tx_remote_min_3.value+'.'+cf.tx_remote_min_4.value;
	if(cf.tx_remote_min.value == "...")
		cf.tx_remote_min.value = "";
	cf.tx_remote_max.value = cf.tx_remote_max_1.value+'.'+cf.tx_remote_max_2.value+'.'+cf.tx_remote_max_3.value+'.'+cf.tx_remote_max_4.value;
	if(cf.tx_remote_max.value == "...")
		cf.tx_remote_max.value = "";

	set_checkbox_value(cf.cb_auth_pap, cf.auth_pap);
	set_checkbox_value(cf.cb_auth_chap, cf.auth_chap);
	set_checkbox_value(cf.cb_auth_ms, cf.auth_ms);

	cf.tx_static_dns.value = cf.tx_static_dns_1.value+'.'+cf.tx_static_dns_2.value+'.'+cf.tx_static_dns_3.value+'.'+cf.tx_static_dns_4.value;
	if(cf.tx_static_dns.value == "...")
		cf.tx_static_dns.value = "";
	if(cf.rd_dns_type.value == 2 && cf.tx_static_dns.value == "")
	{
		alert("please input static DNS server!");
		return false;
	}
	
	cf.tx_static_wins.value = cf.tx_static_wins_1.value+'.'+cf.tx_static_wins_2.value+'.'+cf.tx_static_wins_3.value+'.'+cf.tx_static_wins_4.value;
	if(cf.tx_static_wins.value == "...")
		cf.tx_static_wins.value = "";
	
	if( cf.rd_wins_type.value == 2 && cf.tx_static_wins.value == "" )
	{
		alert("Please input static Wins server!");
		return false;
	}
	set_checkbox_value(cf.cb_allow_broad, cf.allow_broad);
	
	return true;
}

function check_select()
{
	var select_num=0;
	var cf = document.forms[0];
	if( pptp_user_num == 1)
	{
		if(cf.ruleSelect.checked == true)
		{
			select_num = 1;
		}
	}
	else if( pptp_user_num > 1)
	{
		for(var i=0; i<pptp_user_num; i++)
		{
			if(cf.ruleSelect[i].checked == true)
				select_num = i+1;
		}
	}

	return select_num;
}

function click_edit()
{
	var cf = document.forms[0];
	var edit_num = check_select();
	
	if(edit_num == 0 )
	{
		alert("$port_edit");
		return false;
	}
	cf.select_edit.value =edit_num;
	cf.submit_flag.value="vpn_pptp_edit_num";
	cf.action="/apply.cgi?/vpn_pptp_edit.htm timestamp="+ts;

	cf.submit();
}

function click_del()
{
        var cf = document.forms[0];
        var del_num = check_select();

        if(del_num == 0 )
        {
                alert("$port_del");
                return false;
        }
        cf.select_del.value =del_num;
        cf.submit_flag.value="vpn_pptp_del";
        cf.action="/apply.cgi?/vpn_pptp.htm timestamp="+ts;

	cf.submit();
}

</script>

</HTML>
