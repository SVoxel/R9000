<% http_header("style/form2.css", "style/attach_device2.css", "/funcs.js", "/jquery-1.7.2.min.js", "/streamboost.js") %>
<% body_header("_new_attach_device", "QOS_edit_devices.htm", "select_qos_edit") %>

<script language="javascript" type="text/javascript">

var ts='<% cfg_get("select_qos_edit") %>';
var enable_block_device="<% cfg_get("enable_block_device") %>";
var bandwidth_type="<% cfg_get("bandwidth_type") %>";

var wl_ssid="<% cfg_get_ssid_html("wl_ssid") %>";
var wlg1_ssid="<% cfg_get_ssid_html("wlg1_ssid") %>";
var wla_ssid="<% cfg_get_ssid_html("wla_ssid") %>";
var wla1_ssid="<% cfg_get_ssid_html("wla1_ssid") %>";

var uplimit="<% cfg_get("uplimit") %>";
var downlimit="<% cfg_get("downlimit") %>";
var ookla_uplimit="<% cfg_get("ookla_uplimit") %>";
var ookla_downlimit="<% cfg_get("ookla_downlimit") %>";
var show_uplimit="";
var show_downlimit="";
var enable_bridge_flag="<% cfg_get("bridge_mode") %>";
var enable_dev_auto_refresh="<% cfg_get("enable_dev_auto_refresh") %>";
var priority_zone_enable="1";
var zone_num=0;
<% save_timestamp("select_qos_edit", "auto_refresh_value") %>

<% show_applicationNames() %>
<% get_priority_zone_list() %>
var applicationNames=appNameJson.flows;

if(bandwidth_type == "0") {
	show_uplimit=ookla_uplimit;
	show_downlimit=ookla_downlimit;
} else {
	show_uplimit=uplimit;
	show_downlimit=downlimit;
}

var uplink_value=show_uplimit*8/1000;
if(uplink_value==0)
	uplink_value=1000000.00;

var downlink_value=show_downlimit*8/1000;
if(downlink_value==0)
	downlink_value=1000000.00;

var mac_addr=new Array();
var ip_addr=new Array();
var name_addr=new Array();
var prio_addr=new Array();

var xmlHttp;

var byMacDevs={};
var devList=[];
var dln=0;
var byUidFlows={};
var byNameApps={};
var appList=[];
var aln=0;
var byNameFlows={};
var byMacFlows={};
var byZoneNameDevices={};
var zoneList=[];
var outZoneDeviceList=[];

var listBydevice=1;
var listBySort=1;
var mouseon=false;

function listContains(list, obj)
{
	for(var i in list)
	{
		if(list[i] === obj)
			return true;
	}
	
	return false;
}

$$.fn.band_width = function(name, options, totle, color) {
	var settings=options;
	if( this === undefined)
		return;
	if( color === undefined )
		color="#00f";
	var container = jQuery(this);
	var study_voteCount=0;
	study_voteCount = parseFloat(totle).toFixed(2);

	var averageData = parseFloat(settings[0].data).toFixed(2);
	var study_votestr="";
	var studyplay_present=(averageData/study_voteCount*100).toFixed(2);
	if(studyplay_present>100.00)
		studyplay_present=100.00;
	
	if(studyplay_present < 0 )
		studyplay_present=0.00;
		
	//if(studyplay_present>90.00)
		//color="#f00";

	study_votestr += '<div class="outbar"><div class="inbar" style="width:'+studyplay_present+'%;background:'+color+';"></div></div><div class="fl">&nbsp;&nbsp;&nbsp;&nbsp;'+averageData+'Kbps</div>';
	container.html(study_votestr);
}

function band_width_html(data, totle, color)
{
	if( color === undefined )
		color="#00f";

	var study_voteCount=0;
	study_voteCount = parseFloat(totle).toFixed(2);

	var averageData = parseFloat(data).toFixed(2);
	var studyplay_present=(averageData/study_voteCount*100).toFixed(2);
	if(studyplay_present>100.00)
		studyplay_present=100.00;
	
	if(studyplay_present < 0 )
		studyplay_present=0.00;
	if( averageData > 0 && studyplay_present < 0.5 )
		studyplay_present = 0.5;

	//if(studyplay_present>=90.00)
		//color="#f00";
		

	var study_votestr = '<div class="outbar"><div class="inbar" style="width:'+studyplay_present+'%;background:'+color+';"></div></div><div class="fl">&nbsp;&nbsp;&nbsp;&nbsp;'+averageData+'Kbps</div>';

	return study_votestr;
}

function goto_url()
{
	location.href="access_control.htm";
}

function show_wlan_ssid(name)
{
	var wlan_ssid="";
	if(name=="wired")
		wlan_ssid="";
	else if(name=="primary")
		wlan_ssid=" $wlan_guest_ssid: "+wl_ssid;
	else if(name=="guest")
		wlan_ssid=" $wlan_guest_ssid: "+wlg1_ssid;
	else if(name=="primary_an")
		wlan_ssid=" $wlan_guest_ssid: "+wla_ssid;
	else if(name=="guest_an")
		wlan_ssid=" $wlan_guest_ssid: "+wla1_ssid;
	else
		wlan_ssid="";
	return wlan_ssid;
}

var TableSorter1 = new TSorter(0);
function loadvalue()
{
	var dvo = { device:[ <% json_device_info("json", "trend_micro") %> ]}
	if(parent.priority_zone_flag == "1"){
		$$(".zone").css("display", "");
		$$("#listByZone").css("display", "");
		//$$(".refresh").css("display", "none");
	}
	else{
		$$(".zone").css("display", "none");
		$$("#listByZone").css("display", "none");
	}
		
	if(priority_zone_enable == "1")
		initiatePriorityList();
	updateDevice(dvo);
	show_all();
	if(enable_dev_auto_refresh == 1)
	{
		document.forms[0].enable_auto_refresh.checked =true;
		document.forms[0].refresh.style.display = "none";
	}
	getDevices(); //debug hidden
	getTraffic(); //debug hidden
	please_wait(false);
	main_resize();
}

function initiatePriorityList()
{
	for(var i = 0; i < zone_num; i++)
	{
		var tmp_zone = eval("priority_zone"+i);
		var tmp_zone_info = tmp_zone.split("\t");
		var zone_name = tmp_zone_info[0];
		zoneList[i] = new priority_zone(tmp_zone_info[0], tmp_zone_info[1], tmp_zone_info[2], tmp_zone_info[3], tmp_zone_info[4]);
		if(!byZoneNameDevices[zone_name])
			byZoneNameDevices[zone_name] = new Array;
		var j=5;
		while(tmp_zone_info[j])
		{
			var device_info = tmp_zone_info[j].split("*");
			var tmp_device = new device(device_info[0], device_info[1], device_info[2], device_info[3], device_info[4], device_info[5], device_info[6]);
	
			byZoneNameDevices[zone_name].push(tmp_device);
			j++;
		}
		
		
	}
}

function priority_zone(name, download_percent, upload_percent, download_bandwidth, upload_bandwidth)
{
	this.name = name;
	this.download_percent = download_percent;
	this.upload_percent = upload_percent;
	this.down_rate = download_bandwidth;
	this.up_rate = upload_bandwidth;
		
}

function flow(uid, mac, name, down_rate, up_rate)
{
	this.uid = uid;
	this.name = name;
	this.mac = update_mac(this.mac, mac);
	this.down_rate=update(this.down_rate, down_rate/1000*8, mac);
	this.up_rate=update(this.up_rate, up_rate/1000*8, mac);
	this.update_flow=update_flow;
	//average
	this.not_update=update(this.not_update, 0, mac);
	this.zero_times=update(this.zero_times, 0, mac); // if > 3 times, ignore this item.
	this.keep_zero=keep_zero;
	
	function keep_zero(mac)
	{
		if(this.down_rate[mac] == undefined)
			this.down_rate[mac]=0;
		if(this.up_rate[mac] == undefined)
			this.up_rate[mac]=0;

		if(this.down_rate[mac] > 0 || this.up_rate[mac] > 0 )
			this.zero_times[mac]=0;
		else
			this.zero_times[mac]++;
	}
	
	function update_flow(mac, name, down_rate, up_rate)
	{
		if(this.zero_times[mac] == undefined)
			this.zero_times[mac]=0;
		if(down_rate > 0 || up_rate > 0 )
			this.zero_times[mac]=0;
		else
			this.zero_times[mac]++;
		this.mac = update_mac(this.mac, mac);
		this.name = name;
		this.down_rate = update(this.down_rate, down_rate/1000*8, mac);
		this.up_rate = update(this.up_rate, up_rate/1000*8, mac);
	}
	
	function update_mac(be_mac, af_mac)
	{
		var tmp_mac = new Array();
		if(be_mac)
			tmp_mac = be_mac;
		var new_mac = 0;
		for(var i in tmp_mac)
		{
			if(tmp_mac[i] == af_mac)
				new_mac = 1;
		}
		if(new_mac == 0)
			tmp_mac.push(af_mac);
		return tmp_mac;
	}
	
	function update(origin, new_date, m_mac)
	{
		var tmp = new Array();
		if(origin)
			tmp = origin;
		tmp[m_mac] = new_date;
		return tmp;
	}
}

function sig_flow(uid, mac, name, down_rate, up_rate)
{
	this.uid = uid;
	this.mac = mac;
	this.name = name;
	this.down_rate=down_rate;
	this.up_rate=up_rate;
	this.update_flow=update_flow;
	//average
	this.not_update=0;
	this.zero_times=0; // if > 3 times, ignore this item.
	this.keep_zero = keep_zero;
	
	function keep_zero()
	{
		if(this.down_rate > 0 || this.up_rate > 0 )
			this.zero_times=0;
		else
			this.zero_times++;
	}
	
	function update_flow(mac, name, down_rate, up_rate)
	{
		if(down_rate > 0 || up_rate > 0 )
			this.zero_times=0;
		else
			this.zero_times++;
		this.mac = mac;
		this.name = name;
		this.down_rate = down_rate;
		this.up_rate = up_rate;
	}
}

function sum_rate( e, d_rate, u_rate) 
{
	if(e.down_rate != undefined && e.up_rate != undefined)
	{
		e.down_rate = parseFloat(e.down_rate)+parseFloat(d_rate)
		e.up_rate = parseFloat(e.up_rate)+parseFloat(u_rate)
	}
}

function device(mac, ip, name, devtype, contype, priority, access_control, onOff)
{
	this.mac = mac;
	this.ip = ip;
	this.name = name.replace(/[ ]/g, "&nbsp;");
	this.devtype = devtype;
	this.contype = contype;
	this.priority = priority;
	this.down_rate=0.00;
	this.up_rate=0.00;
	this.up_show_sub=0;
	this.down_show_sub=0
	this.clear_rate = clear_rate;
	this.update_rate = update_rate;
	this.set_show_sub = set_show_sub;
	this.update_device = update_device;
	this.access_control = access_control;
	this.setInZoneFlag = setInZoneFlag;
	this.isOnOff = onOff;
	this.inZoneFlag=0;
	
	if( this.ip == "")
		this.ip = "-";
	if( this.name == "")
		this.name = "-";

	function update_device(ip, name, devtype, contype, priority, access_control, updateOnOff)
	{
		this.ip = ip;
		this.name = name.replace(/[ ]/g, "&nbsp;");
		this.devtype = devtype;
		this.contype = contype;
		this.priority = priority;
		this.access_control = access_control;
		this.isOnOff = updateOnOff;
	}
	
	function clear_rate()
	{
		this.down_rate=0.00;
		this.up_rate=0.00		
	}
	
	function update_rate(d_rate, u_rate)
	{
		sum_rate(this, d_rate, u_rate);
	}
	
	function setInZoneFlag(value)
	{
		this.inZoneFlag = value;
	}
	
	function set_show_sub(value)
	{
		//this.show_sub=value;
	}
}

function application(name)
{
	this.name = name;
	this.down_rate = 0.00;
	this.up_rate = 0.00;
	this.up_show_sub=0;
	this.down_show_sub=0;
	this.update_rate = update_rate;
	this.set_show_sub = set_show_sub;
	this.clear_rate=clear_rate;
	//appList[aln++]=this;

	function update_rate(d_rate, u_rate)
	{
		sum_rate(this, d_rate, u_rate);
	}
	
	function clear_rate()
	{
		this.down_rate=0.00;
		this.up_rate=0.00		
	}
	
	function set_show_sub(value)
	{
		//this.show_sub=value;
	}
}

function getDevices()
{
	xmlHttp = createXMLHttpRequest();
	
	var url = "QOS_trend_micro_info.htm?ts=" + new Date().getTime();
	xmlHttp.open("GET",url,true);
	xmlHttp.send(null);
	xmlHttp.onreadystatechange = function()
	{
		if(xmlHttp.readyState == 4 && xmlHttp.status == 200)
		{
			var jobj = eval('('+xmlHttp.responseText+')');
			updateDevice(jobj);
//			updateInfomation(jobj.traffic);
		}
	}

	//var url = "QOS_trend_micro_info.htm?ts=" + new Date().getTime();
	//xmlHttp.open("GET",url,true);
	//xmlHttp.send(null);
	
	if( enable_dev_auto_refresh == 1) 
		setTimeout("getDevices()", 6000);
}

function updateDevice(jobj)
{
	if(jobj.device.length < 2)
		return;

	devList=[];
	outZoneDeviceList=zoneList.concat();
	dln=0;
	outZone_dln=outZoneDeviceList.length;

	var exist_mac = new Array();
	for(var i in jobj.device)
	{
		dev = jobj.device[i];
		
		if( dev.mac )
		{
			var mac = dev.mac.toLowerCase();
			if( byMacDevs[mac] )
				byMacDevs[mac].update_device(dev.ip, dev.name, dev.devtype, dev.contype, dev.priority, dev.access_control, dev.onOrOff);
			else
				byMacDevs[mac] = new device(mac, dev.ip, dev.name, dev.devtype, dev.contype, dev.priority, dev.access_control, dev.onOrOff);
			exist_mac.push(mac);
		}
	}
	for(var z in byMacDevs) {
		if(exist_mac.indexOf(z) == -1)
			delete byMacDevs[z];
	}

	for(var name in byZoneNameDevices)
	{
		var tmp_dev_list = byZoneNameDevices[name];
		for(var i in tmp_dev_list)
		{
			mac = tmp_dev_list[i].mac.toLowerCase();
			if(byMacDevs[mac]){
				if(byMacDevs[mac].inZoneFlag == 0)
					byMacDevs[mac].setInZoneFlag(1);
				tmp_dev_list[i] = byMacDevs[mac];
			}
		}
	}
	
	for(var mac in byMacDevs)
	{
		var dev = byMacDevs[mac];

		devList[dln++]= byMacDevs[mac];
		if(byMacDevs[mac].inZoneFlag == 0){
			outZoneDeviceList[outZone_dln] = byMacDevs[mac];
			outZone_dln++;
		}
	}
	
	
	
}
var traffic_refresh_time=5000;
var timecrc;
var max_trys = 8;
function getTraffic()
{
	tHttp = createXMLHttpRequest();

	var url = "/QOS_flow_info.htm?ts=" + new Date().getTime();
	tHttp.open("GET",url,true);
	tHttp.send(null);
	tHttp.onreadystatechange = function()
	{
		if(tHttp.readyState == 4 && tHttp.status == 200)
		{
			var rsp = tHttp.responseText;
			if(rsp.length < 17 && max_trys>0){
				if(timecrc)
					clearTimeout(timecrc);
				timecrc = setTimeout("getTraffic()", 1000);
				max_trys--;
			}
			else{
				max_trys = 8;
				updateInfomation(rsp);
			}
		}
	}
	if( enable_dev_auto_refresh == 1)
		timecrc = setTimeout("getTraffic()", traffic_refresh_time);
}

function update_relation(f, c_mac)
{
		// check device exist or not
		if(!byMacDevs[c_mac])
			return;
		if( ! listContains(devList, byMacDevs[c_mac]))
			return;
		//update device rate
		byMacDevs[c_mac].update_rate(f.down_rate[c_mac], f.up_rate[c_mac]);

		//update application rate
		if( ! byNameApps[f.name] )
			byNameApps[f.name] = new application(f.name);
		else
			byNameApps[f.name].update_rate(f.down_rate[c_mac], f.up_rate[c_mac]);
		if( ! listContains(appList, byNameApps[f.name]))
			appList[aln++]=byNameApps[f.name];		
		
		// save relationship
		if( ! byMacFlows[c_mac] )
			byMacFlows[c_mac] = new Array;
		if( ! byNameFlows[f.name] )
			byNameFlows[f.name] = new Array;
		var tmp_flows_array = new sig_flow(f.uid, c_mac, f.name, f.down_rate[c_mac], f.up_rate[c_mac]);

		if( ! listContains(byMacFlows[c_mac], tmp_flows_array))
			byMacFlows[c_mac].push(tmp_flows_array);
		if( ! listContains(byNameFlows[f.name], tmp_flows_array))
			byNameFlows[f.name].push(tmp_flows_array);
}

function updateInfomation(rsp)
{
	/* clear */
	byMacFlows={};
	byNameFlows={};
	appList=[];
	aln=0;
	for(var mac in byMacDevs)
		byMacDevs[mac].clear_rate();
	for(var name in byNameApps)
		byNameApps[name].clear_rate();
	for(var uid in byUidFlows)
	{
		for(var c_mac in byUidFlows[uid].mac)
			byUidFlows[uid].not_update[byUidFlows[uid].mac[c_mac]] = 1;
	}

	var debug_str="";
	/* add new value in byMacFlows byNameFlows */
	var flows = rsp.split("$#");
	for(var i=0; i<flows.length ; i++)
	{	
		var each_info = flows[i].split(' ');
		if(each_info.length < 6)
			continue;
		var mac = each_info[0].toLowerCase();
		var uid = each_info[1];
		//console.log(i+": uid=" +uid +"; flow="+flows[i]);
		var name = each_info[2].replace(/[\*]/g, " ");
		var up_rate = each_info[3];
		var down_rate = each_info[5];
	
		if( byUidFlows[uid] === undefined )
			byUidFlows[uid] = new flow(uid, mac, name, down_rate, up_rate);
		else
			byUidFlows[uid].update_flow(mac, name, down_rate, up_rate);

		var f = byUidFlows[uid];
		f.not_update[mac]=0;
		debug_str=debug_str+f.uid+" ";
	}
	debug_str=debug_str+'\n';
	for(var uid in byUidFlows)
	{
		for(var c_mac in byUidFlows[uid].mac)
		{
			var f = byUidFlows[uid];
		
			if( f.not_update[f.mac[c_mac]] == 1)
			{
				f.keep_zero(f.mac[c_mac]);
			}

			//keep zero 3 times
			if(f.zero_times[f.mac[c_mac]] > 3)
				continue;
	
			update_relation(f, f.mac[c_mac]);
		}
	}

	show_all();
}

function update_band_width()
{
	for( var uid in byUidFlows )
	{
		var f = byUidFlows[uid];

		$$("div[name='d"+uid+"']").band_width("d"+uid,[{"data":f.down_rate}],downlink_value, "#5bb6e5");
		$$("div[name='u"+uid+"']").band_width("u"+uid,[{"data":f.up_rate}],downlink_value, "#ababab");

	}

	if( listBydevice == 1 )
	{
		for( var mac in byMacDevs )
		{
			var d = byMacDevs[mac];
			$$("div[name='d"+mac+"']").band_width("d"+mac,[{"data":d.down_rate}],downlink_value, "#5bb6e5");//#f89827
			$$("div[name='u"+mac+"']").band_width("u"+mac,[{"data":d.up_rate}],downlink_value, "#ababab");
		}
	}
	else
	{
		for( var name in byNameApps )
		{
			var a = byNameApps[name];
			$$("div[name='d"+name+"']").band_width("d"+name,[{"data":a.down_rate}],downlink_value, "#5bb6e5");//#f89827
			$$("div[name='u"+name+"']").band_width("u"+name,[{"data":a.up_rate}],downlink_value, "#ababab");
		}
	}
}

function show_up_sub(e, key)
{
	if( byMacDevs[key])
		var item = byMacDevs[key];
	else if( byNameApps[key])
		var item = byNameApps[key];


	if($$(e).attr("src").indexOf("image/dev_minus.gif") != -1 )
	{
		if( item)
			item.up_show_sub=0;
		$$(e).attr("src","image/dev_plus.gif");
		$$(e).closest(".lineright").children("#up_subflow").hide();
	}
	else if($$(e).attr("src").indexOf("image/dev_plus.gif") != -1 )
	{
		if ( item )
			item.up_show_sub=1;
		$$(e).attr("src", "image/dev_minus.gif");
		$$(e).closest(".lineright").children("#up_subflow").show();
	}
}

function show_down_sub(e, key)
{
	if( byMacDevs[key])
		var item = byMacDevs[key];
	else if( byNameApps[key])
		var item = byNameApps[key];

	if($$(e).attr("src").indexOf("image/dev_minus.gif") != -1 )
	{
		if( item)
			item.down_show_sub=0;
		$$(e).attr("src","image/dev_plus.gif");
		$$(e).closest(".lineright").children("#down_subflow").hide();
	}
	else if($$(e).attr("src").indexOf("image/dev_plus.gif") != -1 )
	{
		if ( item )
			item.down_show_sub=1;
		$$(e).attr("src", "image/dev_minus.gif");
		$$(e).closest(".lineright").children("#down_subflow").show();
	}
}

function zone_show_up_sub(e, key, zone_count)
{
	if( byMacDevs[key])
		var item = byMacDevs[key];
	else if( byNameApps[key])
		var item = byNameApps[key];
	var name_length = $$('#priority_zone'+zone_count+'_name').height();
	var bracket_length = $$('#priority_zone_bracket'+zone_count).height();


	if($$(e).attr("src").indexOf("image/dev_minus.gif") != -1 )
	{
		if( item)
			item.up_show_sub=0;
		$$(e).attr("src","image/dev_plus.gif");
		bracket_length = bracket_length - $$(e).closest(".lineright").children("#up_subflow").height();
		$$(e).closest(".lineright").children("#up_subflow").hide();
		
	}
	else if($$(e).attr("src").indexOf("image/dev_plus.gif") != -1 )
	{
		if ( item )
			item.up_show_sub=1;
		$$(e).attr("src", "image/dev_minus.gif");
		bracket_length = bracket_length + $$(e).closest(".lineright").children("#up_subflow").height();
		$$(e).closest(".lineright").children("#up_subflow").show();
	}
	$$('#priority_zone'+zone_count+'_name').css("top", (bracket_length-name_length)/2+50);
	$$('#priority_zone'+zone_count+'_bandwidth').css("top", bracket_length/2-17+50);
}

function zone_show_down_sub(e, key, zone_count)
{
	if( byMacDevs[key])
		var item = byMacDevs[key];
	else if( byNameApps[key])
		var item = byNameApps[key];
	var name_length = $$('#priority_zone'+zone_count+'_name').height();
	var bracket_length = $$('#priority_zone_bracket'+zone_count).height();

	if($$(e).attr("src").indexOf("image/dev_minus.gif") != -1 )
	{
		if( item)
			item.down_show_sub=0;
		$$(e).attr("src","image/dev_plus.gif");
		bracket_length = bracket_length - $$(e).closest(".lineright").children("#up_subflow").height();
		$$(e).closest(".lineright").children("#down_subflow").hide();
	}
	else if($$(e).attr("src").indexOf("image/dev_plus.gif") != -1 )
	{
		if ( item )
			item.down_show_sub=1;
		$$(e).attr("src", "image/dev_minus.gif");
		bracket_length = bracket_length + $$(e).closest(".lineright").children("#up_subflow").height();
		$$(e).closest(".lineright").children("#down_subflow").show();
	}
	$$('#priority_zone'+zone_count+'_name').css("top", (bracket_length-name_length)/2+50);
	$$('#priority_zone'+zone_count+'_bandwidth').css("top", bracket_length/2-17+50);
}

function show_bandwidth(zone_count)
{
	document.getElementById("priority_zone"+zone_count+"_bandwidth").style.display="";
	var length = $$('#priority_zone_bracket'+zone_count).height();
	
}

function hide_bandwidth(zone_count)
{
	document.getElementById("priority_zone"+zone_count+"_bandwidth").style.display="none";
	
	
}
function show_all()
{
	var cf = document.forms[0];
	var count = 0;
	$$('#main').empty();

	if(listBySort == 0 )
		var sort_function = sort_bandwidth;
	else if( listBySort == 2 && listBydevice == 1)
		var sort_function = sort_con;
	else
		var sort_function =sort_alp;
	
	//dev.name.replace(/\\/g,"\\\\"); //Escape \ 'and'
	//dev.name.replace(/&#39;/g,"\\&#39;");//Escape \ 'and'
	
	if( listBydevice == 1 )
	{
		if(devList.length) devList.sort(sort_function).sort(sort_on_off);

		for( var i in devList )
		{
			var dev = devList[i];
			var subList = byMacFlows[dev.mac];
			var linehtml = "";

			if ( subList && listBySort !=2 && subList.length ) subList.sort(sort_function).sort(sort_on_off);
			if(dev.up_show_sub == 1 )
			{
				var up_ssrc = 'image/dev_minus.gif';
				var up_sstyle= '';
			}
			else{
				var up_ssrc = 'image/dev_plus.gif';
				var up_sstyle = 'style="display:none"';
			}
			if(dev.down_show_sub == 1 )
			{
				var down_ssrc = 'image/dev_minus.gif';
				var down_sstyle= '';
			}
			else{
				var down_ssrc = 'image/dev_plus.gif';
				var down_sstyle = 'style="display:none"';
			}
			if(type_list[dev.devtype] == undefined)
				dev.devtype = 47;
			linehtml='<div class="oneline">';
			linehtml=linehtml+'<div class="lineleft"  >';
			if(dev.isOnOff == 1)
				linehtml=linehtml+'<div class="devIcon big-corner-all" title="$qos_mac: '+dev.mac+'&#13$device_type: '+type_list[dev.devtype][0]+show_wlan_ssid(dev.contype)+'"    onclick="edit_select_device(\''+dev.mac+'\',\''+dev.ip+'\',\''+dev.name.replace(/\\/g,"\\\\").replace(/&#39;/g,"\\&#39;")+'\', \''+dev.priority+'\', \''+dev.devtype+'\',\''+dev.contype+'\', \''+dev.isOnOff+'\' );">';
			else
				linehtml=linehtml+'<div class="devIcon big-corner-all" style="background-color:#949599" title="$qos_mac: '+dev.mac+'&#13$device_type: '+type_list[dev.devtype][0]+show_wlan_ssid(dev.contype)+'"    onclick="edit_select_device(\''+dev.mac+'\',\''+dev.ip+'\',\''+dev.name.replace(/\\/g,"\\\\").replace(/&#39;/g,"\\&#39;")+'\', \''+dev.priority+'\', \''+dev.devtype+'\',\''+dev.contype+'\', \''+dev.isOnOff+'\' );">';
			linehtml=linehtml+'<img src=image/streamboost/'+type_list[dev.devtype][2]+'.jpg width=66px height=44px id=icon_img />';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="devType">';
			linehtml=linehtml+show_type(dev.contype);
			linehtml=linehtml+'</div>';
			if(enable_block_device == "1")
				linehtml=linehtml+'<div class="devName"><b>'+dev.name+'</b><br/><br/>'+dev.ip+'<br/>'+show_bora(dev.access_control)+'</div>';
			else
				linehtml=linehtml+'<div class="devName"><b>'+dev.name+'</b><br/><br/>'+dev.ip+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="lineright">';
			linehtml=linehtml+'<div class="basicFlow">';
			linehtml=linehtml+'<div class="flowline">';
			if(subList) linehtml=linehtml+'<img class="down_showsub" onclick="show_down_sub(this, \''+dev.mac+'\')"  src='+down_ssrc+' >&nbsp;&nbsp;&nbsp; ';
			linehtml=linehtml+'<div class="title">';
			linehtml=linehtml+"$inter_down</div>";
			linehtml=linehtml+'<div class="flowshow" name="d'+dev.mac+'">';
				linehtml=linehtml+band_width_html(dev.down_rate,downlink_value, "#5bb6e5");
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			var debug_down=dev.down_rate + " ";
			var debug_up=dev.up_rate + " ";
			var showList={};
			

			for( var i in subList)
			{
				var f = subList[i];
				var name = f.name;
				if(showList[name])
				{
					showList[name].down_rate = (parseFloat(showList[name].down_rate) +  parseFloat(f.down_rate));
					showList[name].up_rate = (parseFloat(showList[name].up_rate) +  parseFloat(f.up_rate));
				}
				else{
					showList[name]={down_rate: f.down_rate,up_rate: f.up_rate};
				}	
			}
			linehtml=linehtml+'<div class="subFlow" id="down_subflow" '+down_sstyle+'>';
			for( var name in showList)
			{
				var f = showList[name];
				linehtml=linehtml+'<div class="flowline">';
				linehtml=linehtml+'<div class="title">'+name+'</div>';
				linehtml=linehtml+'<div class="flowshow">';
					linehtml=linehtml+band_width_html(f.down_rate,downlink_value, "#5bb6e5");
					debug_down=debug_down+f.down_rate + " ";
				linehtml=linehtml+'</div>';	
				linehtml=linehtml+'</div>';
			}
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="basicFlow">';
			linehtml=linehtml+'<div class="flowline">';
			if(subList) linehtml=linehtml+'<img class="showsub" onclick="show_up_sub(this, \''+dev.mac+'\')"  src='+up_ssrc+' >&nbsp;&nbsp;&nbsp; ';
			linehtml=linehtml+'<div class="title">';
			linehtml=linehtml+"$inter_up</div>";
			linehtml=linehtml+'<div class="flowshow" name="u'+dev.mac+'">';
				linehtml=linehtml+band_width_html(dev.up_rate,downlink_value, "#ababab");
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="subFlow" id="up_subflow"'+up_sstyle+'>';
			for( var name in showList)
			{
				var f = showList[name];
				linehtml=linehtml+'<div class="flowline">';
				linehtml=linehtml+'<div class="title">'+name+'</div>';
				linehtml=linehtml+'<div class="flowshow" >';
					linehtml=linehtml+band_width_html(f.up_rate,downlink_value, "#ababab");
					debug_up=debug_up+f.up_rate + " ";
					
				linehtml=linehtml+'</div>';
				linehtml=linehtml+'</div>';
			}
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="spliteline"></div>';
			linehtml=linehtml+'</div>';
		  $$('#main').append(linehtml);
		}
	}
	else if(listBydevice == 0)
	{
		if(appList.length) appList.sort(sort_function);
		for( var i in appList )
		{
			var a = appList[i];
			var app_name = a.name;
			var subList = byNameFlows[a.name];
			var linehtml = "";			
			if ( subList && subList.length) subList.sort(sort_function);
			
			if(a.up_show_sub == 1 )
			{
				
				var up_ssrc = 'image/dev_minus.gif';
				var up_sstyle= '';
			}
			else{
				var up_ssrc = 'image/dev_plus.gif';
				var up_sstyle = 'style="display:none"';
			}

			if(a.down_show_sub == 1 )
			{
				var down_ssrc = 'image/dev_minus.gif';
				var down_sstyle= '';
			}
			else{
				var down_ssrc = 'image/dev_plus.gif';
				var down_sstyle = 'style="display:none"';
			}
			linehtml='<div class="oneline">';
			linehtml=linehtml+'<div class="lineleft" >';
			//linehtml=linehtml+'<div class="devIcon big-corner-all">';
			//linehtml=linehtml+'<img src=image/streamboost/'+type_list[dev.devtype][2]+'.jpg width=66px height=44px id=icon_img />';
			//linehtml=linehtml+'</div>';
			//linehtml=linehtml+'<div class="devType">';
			//linehtml=linehtml+show_type(dev.contype);
			//linehtml=linehtml+'</div>';
			//linehtml=linehtml+'<div class="devName"><b>'+name+'</b></div>';
			linehtml=linehtml+'<div class="appName"><div class="appdot"></div><b>'+app_name+'</b></div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="lineright">';
			linehtml=linehtml+'<div class="basicFlow">';
			linehtml=linehtml+'<div class="flowline">';
			if( subList) linehtml=linehtml+'<img class="down_showsub" onclick="show_down_sub(this, \''+app_name+'\')" src='+down_ssrc+' >&nbsp;&nbsp;&nbsp; ';
			linehtml=linehtml+'<div class="title">';
			linehtml=linehtml+"$inter_down</div>";
			linehtml=linehtml+'<div class="flowshow" name="d'+app_name+'">';
				linehtml=linehtml+band_width_html(a.down_rate,downlink_value, "#5bb6e5");
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			var showList={};
			for( var i in subList)
			{
				var f = subList[i];
				var dev = byMacDevs[f.mac];
				var dev_name = dev.name
				var c_mac = dev.mac;
				if(showList[c_mac])
				{
					showList[c_mac].down_rate = (parseFloat(showList[c_mac].down_rate) +  parseFloat(f.down_rate));
					showList[c_mac].up_rate = (parseFloat(showList[c_mac].up_rate) +  parseFloat(f.up_rate));
				}
				else{
					showList[c_mac]={down_rate: f.down_rate,up_rate: f.up_rate};
				}
				showList[c_mac].name = dev_name;
			}
			linehtml=linehtml+'<div class="subFlow" id="down_subflow" '+down_sstyle+'>';
			for( var m_mac in showList)
			{
				var f = showList[m_mac];
				linehtml=linehtml+'<div class="flowline">';
				linehtml=linehtml+'<div class="title">'+f.name+'</div>';
				linehtml=linehtml+'<div class="flowshow">';
					linehtml=linehtml+band_width_html(f.down_rate,downlink_value, "#5bb6e5");
				linehtml=linehtml+'</div>';
				linehtml=linehtml+'</div>';
				
			}
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="basicFlow">';
			linehtml=linehtml+'<div class="flowline">';
			if( subList) linehtml=linehtml+'<img class="showsub" onclick="show_up_sub(this, \''+app_name+'\')" src='+up_ssrc+' >&nbsp;&nbsp;&nbsp; ';
			linehtml=linehtml+'<div class="title">';
			linehtml=linehtml+"$inter_up</div>";
			linehtml=linehtml+'<div class="flowshow" name="u'+f.name+'">';
				linehtml=linehtml+band_width_html(a.up_rate,downlink_value, "#ababab");
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="subFlow" id="up_subflow"'+up_sstyle+'>';
			
			for( var m_mac in showList)
			{
				var f = showList[m_mac];
				linehtml=linehtml+'<div class="flowline">';
				linehtml=linehtml+'<div class="title">'+f.name+'</div>';
				linehtml=linehtml+'<div class="flowshow" >';
					linehtml=linehtml+band_width_html(f.up_rate,downlink_value, "#ababab");
				linehtml=linehtml+'</div>';
				linehtml=linehtml+'</div>';
	
			}
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'</div>';
			linehtml=linehtml+'<div class="spliteline"></div>';
			linehtml=linehtml+'</div>';
			$$('#main').append(linehtml);
		}
	}else if(listBydevice == 2){
		
		if(outZoneDeviceList.length) outZoneDeviceList.sort(sort_function);
		//alert("outZoneDeviceList"+outZoneDeviceList.length);
		for(var i in outZoneDeviceList){
			if(!outZoneDeviceList[i].mac ){//priority zone
				
				var zone_name = outZoneDeviceList[i].name;
				var zone_devlist = byZoneNameDevices[zone_name];
				if(zone_devlist.length == 0)
					continue;
				for(var zone_count in zoneList)
					if(zoneList[zone_count].name == zone_name)
						break;
				linehtml = '<div class="priority_zone" id="priority_zone'+zone_count+'">';
				linehtml = linehtml + '<div class="zone_bracket"  id="priority_zone_bracket'+zone_count+'"></div>';
				linehtml = linehtml + '<div class="zone_name" onmouseover="show_bandwidth('+zone_count+')" onmouseout="hide_bandwidth('+zone_count+')" id="priority_zone'+zone_count+'_name"><div style="width:1px">'+zone_name + '</div>';
				
				linehtml = linehtml + '</div>'
				linehtml = linehtml + '<div class="zone_edit" id="zone_edit'+zone_count+'"><input type="button" name="edit" class="zone_edit_bt ui-corner-all" value="Edit" id="edit_bt" onclick="location.href=\'priority_zone.htm\'"></div>';
				linehtml = linehtml + '<div class="zone_bandwidth ui-corner-all" id="priority_zone'+zone_count+'_bandwidth" ><span class="cusp01"><span class="cusp02"></span></span> '+outZoneDeviceList[i].up_rate+'Mbps</div>';
				
				
				
				//alert("zone_devlist"+zone_devlist.length);
				for(var j in zone_devlist){
					
					var dev = zone_devlist[j];
					var subList = byMacFlows[dev.mac];
					//var linehtml = "";

					if ( subList && listBySort !=2 && subList.length ) subList.sort(sort_function);
					if(dev.up_show_sub == 1 )
					{
						var up_ssrc = 'image/dev_minus.gif';
						var up_sstyle= '';
					}
					else{
						var up_ssrc = 'image/dev_plus.gif';
						var up_sstyle = 'style="display:none"';
					}
					if(dev.down_show_sub == 1 )
					{
						var down_ssrc = 'image/dev_minus.gif';
						var down_sstyle= '';
					}
					else{
						var down_ssrc = 'image/dev_plus.gif';
						var down_sstyle = 'style="display:none"';
					}

					linehtml=linehtml+'<div class="oneline">';
					linehtml=linehtml+'<div class="lineleft"  >';
					var online_flag=0;
					for(var i in devList)
						if(devList[i].mac == dev.mac){
							online_flag = 1;
							break;
						}
					if(online_flag == 1)
						linehtml=linehtml+'<div class="devIcon big-corner-all" title="$qos_mac: '+dev.mac+'&#13$device_type: '+type_list[dev.devtype][0]+show_wlan_ssid(dev.contype)+'"    onclick="edit_select_device(\''+dev.mac+'\',\''+dev.ip+'\',\''+dev.name.replace(/\\/g,"\\\\").replace(/&#39;/g,"\\&#39;")+'\', \''+dev.priority+'\', \''+dev.devtype+'\',\''+dev.contype+'\' );">';
					else
						linehtml=linehtml+'<div class="devIcon big-corner-all" style="background-color:#949599" title="$qos_mac: '+dev.mac+'&#13$device_type: '+type_list[dev.devtype][0]+show_wlan_ssid(dev.contype)+'"    onclick="edit_select_device(\''+dev.mac+'\',\''+dev.ip+'\',\''+dev.name.replace(/\\/g,"\\\\").replace(/&#39;/g,"\\&#39;")+'\', \''+dev.priority+'\', \''+dev.devtype+'\',\''+dev.contype+'\' );">';
					linehtml=linehtml+'<img src=image/streamboost/'+type_list[dev.devtype][2]+'.jpg width=66px height=44px id=icon_img />';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="devType">';
					linehtml=linehtml+show_type(dev.contype);
					linehtml=linehtml+'</div>';
					if(enable_block_device == "1")
						linehtml=linehtml+'<div class="devName"><b>'+dev.name+'</b><br/><br/>'+dev.ip+'<br/>'+show_bora(dev.access_control)+'</div>';
					else
						linehtml=linehtml+'<div class="devName"><b>'+dev.name+'</b><br/><br/>'+dev.ip+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="lineright">';
					linehtml=linehtml+'<div class="basicFlow">';
					linehtml=linehtml+'<div class="flowline">';
					if(subList) linehtml=linehtml+'<img class="down_showsub" onclick="zone_show_down_sub(this, \''+dev.mac+'\', \''+zone_count+'\')"  src='+down_ssrc+' >&nbsp;&nbsp;&nbsp; ';
					linehtml=linehtml+'<div class="title">';
					linehtml=linehtml+"$inter_down</div>";
					linehtml=linehtml+'<div class="flowshow" name="d'+dev.mac+'">';
					linehtml=linehtml+band_width_html(dev.down_rate,downlink_value, "#5bb6e5");
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					var debug_down=dev.down_rate + " ";
					var debug_up=dev.up_rate + " ";
					var showList={};
			
			
					for( var i in subList)
					{
						var f = subList[i];
						var name = f.name;
						if(showList[name])
						{
							showList[name].down_rate = (parseFloat(showList[name].down_rate) +  parseFloat(f.down_rate));
							showList[name].up_rate = (parseFloat(showList[name].up_rate) +  parseFloat(f.up_rate));
						}
						else{
							showList[name]={down_rate: f.down_rate,up_rate: f.up_rate};
						}	
					}
					linehtml=linehtml+'<div class="subFlow" id="down_subflow" '+down_sstyle+'>';
					for( var name in showList)
					{
						var f = showList[name];
						linehtml=linehtml+'<div class="flowline">';
						linehtml=linehtml+'<div class="title">'+name+'</div>';
						linehtml=linehtml+'<div class="flowshow">';
						linehtml=linehtml+band_width_html(f.down_rate,downlink_value, "#5bb6e5");
						debug_down=debug_down+f.down_rate + " ";
						linehtml=linehtml+'</div>';	
						linehtml=linehtml+'</div>';
					}
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="basicFlow">';
					linehtml=linehtml+'<div class="flowline">';
					if(subList) linehtml=linehtml+'<img class="showsub" onclick="zone_show_up_sub(this, \''+dev.mac+'\', \''+zone_count+'\')"  src='+up_ssrc+' >&nbsp;&nbsp;&nbsp; ';
					linehtml=linehtml+'<div class="title">';
					linehtml=linehtml+"$inter_up</div>";
					linehtml=linehtml+'<div class="flowshow" name="u'+dev.mac+'">';
					linehtml=linehtml+band_width_html(dev.up_rate,downlink_value, "#ababab");
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="subFlow" id="up_subflow"'+up_sstyle+'>';
					for( var name in showList)
					{
						var f = showList[name];
						linehtml=linehtml+'<div class="flowline">';
						linehtml=linehtml+'<div class="title">'+name+'</div>';
						linehtml=linehtml+'<div class="flowshow" >';
						linehtml=linehtml+band_width_html(f.up_rate,downlink_value, "#ababab");
						debug_up=debug_up+f.up_rate + " ";
					
						linehtml=linehtml+'</div>';
						linehtml=linehtml+'</div>';
					}
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="spliteline"></div>';
					linehtml=linehtml+'</div>';
					
				}
				linehtml = linehtml + '</div>';
				$$('#main').append(linehtml);
				var length = $$('#priority_zone'+zone_count).height()-170;
				$$('#priority_zone_bracket'+zone_count).height(length);
				//$$('#priority_zone'+zone_count+' .oneline').css("top", 0-length-19);
				var height = $$('#priority_zone'+zone_count+'_name').height();
				$$('#priority_zone'+zone_count+'_name').css("top", (length-height)/2+50);
				$$('#priority_zone'+zone_count+'_bandwidth').css("top", length/2-17+50);
				
				
				
				
			}else{
					var dev = outZoneDeviceList[i];
					var subList = byMacFlows[dev.mac];
					var linehtml = "";

					if ( subList && listBySort !=2 && subList.length ) subList.sort(sort_function);
					if(dev.up_show_sub == 1 )
					{
						var up_ssrc = 'image/dev_minus.gif';
						var up_sstyle= '';
					}
					else{
						var up_ssrc = 'image/dev_plus.gif';
						var up_sstyle = 'style="display:none"';
					}
					if(dev.down_show_sub == 1 )
					{
						var down_ssrc = 'image/dev_minus.gif';
						var down_sstyle= '';
					}
					else{
						var down_ssrc = 'image/dev_plus.gif';
						var down_sstyle = 'style="display:none"';
					}

					linehtml=linehtml+'<div class="oneline">';
					linehtml=linehtml+'<div class="lineleft"  >';
					linehtml=linehtml+'<div class="devIcon big-corner-all" title="$qos_mac: '+dev.mac+'&#13$device_type: '+type_list[dev.devtype][0]+show_wlan_ssid(dev.contype)+'"    onclick="edit_select_device(\''+dev.mac+'\',\''+dev.ip+'\',\''+dev.name.replace(/\\/g,"\\\\").replace(/&#39;/g,"\\&#39;")+'\', \''+dev.priority+'\', \''+dev.devtype+'\',\''+dev.contype+'\' );">';
					linehtml=linehtml+'<img src=image/streamboost/'+type_list[dev.devtype][2]+'.jpg width=66px height=44px id=icon_img />';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="devType">';
					linehtml=linehtml+show_type(dev.contype);
					linehtml=linehtml+'</div>';
					if(enable_block_device == "1")
						linehtml=linehtml+'<div class="devName"><b>'+dev.name+'</b><br/><br/>'+dev.ip+'<br/>'+show_bora(dev.access_control)+'</div>';
					else
						linehtml=linehtml+'<div class="devName"><b>'+dev.name+'</b><br/><br/>'+dev.ip+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="lineright">';
					linehtml=linehtml+'<div class="basicFlow">';
					linehtml=linehtml+'<div class="flowline">';
					if(subList) linehtml=linehtml+'<img class="down_showsub" onclick="show_down_sub(this, \''+dev.mac+'\')"  src='+down_ssrc+' >&nbsp;&nbsp;&nbsp; ';
					linehtml=linehtml+'<div class="title">';
					linehtml=linehtml+"$inter_down</div>";
					linehtml=linehtml+'<div class="flowshow" name="d'+dev.mac+'">';
					linehtml=linehtml+band_width_html(dev.down_rate,downlink_value, "#5bb6e5");
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					var debug_down=dev.down_rate + " ";
					var debug_up=dev.up_rate + " ";
					var showList={};
			
			
					for( var i in subList)
					{
						var f = subList[i];
						var name = f.name;
						if(showList[name])
						{
							showList[name].down_rate = (parseFloat(showList[name].down_rate) +  parseFloat(f.down_rate));
							showList[name].up_rate = (parseFloat(showList[name].up_rate) +  parseFloat(f.up_rate));
						}
						else{
							showList[name]={down_rate: f.down_rate,up_rate: f.up_rate};
						}	
					}
					linehtml=linehtml+'<div class="subFlow" id="down_subflow" '+down_sstyle+'>';
					for( var name in showList)
					{
						var f = showList[name];
						linehtml=linehtml+'<div class="flowline">';
						linehtml=linehtml+'<div class="title">'+name+'</div>';
						linehtml=linehtml+'<div class="flowshow">';
						linehtml=linehtml+band_width_html(f.down_rate,downlink_value, "#5bb6e5");
						debug_down=debug_down+f.down_rate + " ";
						linehtml=linehtml+'</div>';	
						linehtml=linehtml+'</div>';
					}
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="basicFlow">';
					linehtml=linehtml+'<div class="flowline">';
					if(subList) linehtml=linehtml+'<img class="showsub" onclick="show_up_sub(this, \''+dev.mac+'\')"  src='+up_ssrc+' >&nbsp;&nbsp;&nbsp; ';
					linehtml=linehtml+'<div class="title">';
					linehtml=linehtml+"$inter_up</div>";
					linehtml=linehtml+'<div class="flowshow" name="u'+dev.mac+'">';
					linehtml=linehtml+band_width_html(dev.up_rate,downlink_value, "#ababab");
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="subFlow" id="up_subflow"'+up_sstyle+'>';
					for( var name in showList)
					{
						var f = showList[name];
						linehtml=linehtml+'<div class="flowline">';
						linehtml=linehtml+'<div class="title">'+name+'</div>';
						linehtml=linehtml+'<div class="flowshow" >';
						linehtml=linehtml+band_width_html(f.up_rate,downlink_value, "#ababab");
						debug_up=debug_up+f.up_rate + " ";
					
						linehtml=linehtml+'</div>';
						linehtml=linehtml+'</div>';
					}
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'</div>';
					linehtml=linehtml+'<div class="spliteline"></div>';
					linehtml=linehtml+'</div>';
					$$('#main').append(linehtml);
			}
			
		}
	
	}

	//update_band_width();
}

function change_list_type(type)
{
	if( listBydevice != type)
	{
		listBydevice = type;

		if( listBydevice == 1 )
		{
			$$("#sortCon").show();
			$$(".bt_contain").children().eq(0).css("margin-right", "5px");
			$$("#listByDevice").closest(".btc1").children(".btopen").removeClass("btopen").addClass("btclose");
			$$("#listByDevice").removeClass("btclose").addClass("btopen");
			
			show_all();
		}
		else if( listBydevice == 0)
		{
			var sortConWidth = (parseInt($$("#sortCon").width()) + 2 + 20 + 5) + "px";
			$$("#sortCon").hide();
			$$(".bt_contain").children().eq(0).css("margin-right", sortConWidth);
			$$("#listByApplication").closest(".btc1").children(".btopen").removeClass("btopen").addClass("btclose");
			$$("#listByApplication").removeClass("btclose").addClass("btopen");
			if( listBySort == 2 )
				change_sort_type(1);
			else
				show_all();
		}else{
			var sortConWidth = (parseInt($$("#sortCon").width()) + 2 + 20 + 5) + "px";
			$$("#sortCon").hide();
			$$(".bt_contain").children().eq(0).css("margin-right", sortConWidth);
			$$("#listByZone").closest(".btc1").children(".btopen").removeClass("btopen").addClass("btclose");
			$$("#listByZone").removeClass("btclose").addClass("btopen");
			if( listBySort == 2 )
				change_sort_type(1);
			else{
				show_all();
			}
		}
	}
}

function change_sort_type(type)
{
	if( listBySort != type)
	{
		listBySort = type;

		if( type == 0 )
		{
			$$("#sortBand").closest(".btc1").children(".btopen").removeClass("btopen").addClass("btclose");
			$$("#sortBand").removeClass("btclose").addClass("btopen");
		}
		else if( type == 1 )
		{
			$$("#sortAp").closest(".btc1").children(".btopen").removeClass("btopen").addClass("btclose");
			$$("#sortAp").removeClass("btclose").addClass("btopen");
		}
		else
		{
			$$("#sortCon").closest(".btc1").children(".btopen").removeClass("btopen").addClass("btclose");
			$$("#sortCon").removeClass("btclose").addClass("btopen");
		}
		show_all();
	}
}

function refresh_device_info()
{
	getDevices();
	getTraffic();
}
</script>
<input type="hidden" name="hid_mac">
<input type="hidden" name="hid_edit_mac">
<input type="hidden" name="hid_dev_auto_refresh" value="0">
<div id="top-banner">
<div class="page_title">$attach_device</div>
<div class="access">$access_control_url1
<script>
	if(enable_bridge_flag == "1")
		document.write('<a href=# class="ui-corner-all"><font color=grey>&nbsp; $access_control_url2 &nbsp;</font></a>');
	else
		document.write('<a href=# onclick="goto_url(); return false;" class="ui-corner-all">&nbsp; $access_control_url2 &nbsp;</a>');

	document.write('$access_control_url3<br/>');

	var new_device_statue_by_default="<% cfg_get("new_device_statue_by_default") %>";

	if( enable_block_device == "0" )
	{
		document.write("$acc_control: <b>$acc_turned_off</b>");
	}
	else
	{
		document.write("$acc_control: <b>$acc_turned_on</b>");
		document.write("<br/>");
		if( new_device_statue_by_default == "Block" )
			document.write("$acc_general_rule: $block_connect");
		else
			document.write("$acc_general_rule: $allow_connect");
	}
</script>
</div>
<div class="zone">$access_control_url1
<a href=# onclick="goto_url(); return false;" class="ui-corner-all">&nbsp; $priority_zone &nbsp;</a>
$set_priority_zone<br/>
<script>
if(priority_zone_enable == "1")
	document.write("$priority_zone: <b>$acc_turned_on</b>");
else
	document.write("$priority_zone: <b>$acc_turned_off</b>");
</script>
</div>
<div class="top-settings">
<table width="100%">
<tr>
<td><div class="total_bandwith">$total_band</div></td>
<td>
<div class="rates">
<div class="down_rate"><div class="ratefont"><script>document.write(parseFloat(show_downlimit*8/1000000).toFixed(2)+" Mbps")</script></div></div>
<div class="up_rate"><div class="ratefont"><script>document.write(parseFloat(show_uplimit*8/1000000).toFixed(2)+" Mbps")</script></div></div>
</div></td>
<td align="right">
<div class="refresh">
<input type="checkbox" value="0" name="enable_auto_refresh" onClick="show_or_hid_refresh(document.forms[0],'0');">$enable_auto_refresh &nbsp;
<input class="new_apply_bt ui-corner-all" type='button' name='refresh' value='$refresh_mark' onClick='refresh_device_info()'>
</div>
</td>
</tr>
</table>
<!--div style="width:200px; height:100px; position: absolute; top: 70px; right: 0px; ">
<script>
function change_time()
{
	var cf = document.forms[0];
	var t = parseInt(cf.trt.value)
	if(t == 0)
		t=1;
	traffic_refresh_time = t*1000;
	
	clearTimeout(timecrc);
	getTraffic();
}
</script>
<input name="trt" type=text value=1 > <input type=button value="Change Refresh time" onclick="change_time()">
</div-->
<div class="bt_contain" >
<div class="btc1 ui-corner-all">
$sort_by<div id="sortBand" class="btclose ui-corner-all" onclick="change_sort_type(0);">$band</div>&nbsp;&nbsp;<div id="sortAp" class="btopen ui-corner-all" onclick="change_sort_type(1);">$alp_ord</div>&nbsp;&nbsp;<div id="sortCon" class="btclose ui-corner-all" onclick="change_sort_type(2);">$con_tp</div>
</div>
<div class="btc1 ui-corner-all">
$ls_by &nbsp;<div id="listByApplication" class="btclose ui-corner-all" onclick="change_list_type(0)">$app</div>&nbsp;&nbsp;<div  id="listByDevice" class="btopen ui-corner-all" onclick="change_list_type(1)">$dev</div>&nbsp;&nbsp;<div  id="listByZone" class="btclose ui-corner-all" onclick="change_list_type(2)">Zone</div>
</div>
</div>

<div class="application_num">
<table>
<tr><td><input type="checkbox" name="limit_app_name" onclick="show_all()"></td>
<td><b>$display_top_5_band</b></td>
</tr>
</table>
</div>
</div>

<div class="page-line"><img src=image/topline.gif width=100%></div>
</div>
<div id="main" class="main">

</div>
<script>
function main_resize() 
{
	var topHeight = $$('#top-banner').outerHeight();
	$$('#main').css('top', topHeight);
}
$$(window).resize (function () {
	 main_resize();
});
main_resize();
</script>
<% help_box("1","_new_attach_device") %>
</form>
</body>
</html>

